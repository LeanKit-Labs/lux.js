/**
 * lux.js - Flux-based architecture for using ReactJS at LeanKit
 * Author: Jim Cowart
 * Version: v0.5.1
 * Url: https://github.com/LeanKit-Labs/lux.js
 * License(s): MIT Copyright (c) 2014 LeanKit
 */
"use strict";var _slicedToArray=function(t,n){if(Array.isArray(t))return t;for(var e,r=[],o=t[Symbol.iterator]();!(e=o.next()).done&&(r.push(e.value),!n||r.length!==n););return r},_toArray=function(t){return Array.isArray(t)?t:Array.from(t)},_get=function t(n,e,r){var o=Object.getOwnPropertyDescriptor(n,e);if(void 0===o){var i=Object.getPrototypeOf(n);return null===i?void 0:t(i,e,r)}if("value"in o&&o.writable)return o.value;var a=o.get;return void 0===a?void 0:a.call(r)},_inherits=function(t,n){if("function"!=typeof n&&null!==n)throw new TypeError("Super expression must either be null or a function, not "+typeof n);t.prototype=Object.create(n&&n.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),n&&(t.__proto__=n)},_prototypeProperties=function(t,n,e){n&&Object.defineProperties(t,n),e&&Object.defineProperties(t.prototype,e)},_classCallCheck=function(t,n){if(!(t instanceof n))throw new TypeError("Cannot call a class as a function")};(function(t,n){if("function"==typeof define&&define.amd)define(["react","postal","machina","lodash"],n);else{if("object"!=typeof module||!module.exports)throw new Error("Sorry - luxJS only support AMD or CommonJS module environments.");module.exports=function(t,e,r,o){return n(t||require("react"),e||require("postal"),r||require("machina"),o||require("lodash"))}}})(void 0,function(t,n,e,r){function o(t,n){var e=n.reduce(function(n,e){return n[e]=t[e],n},{});return e}function i(t,e){return e.context(t).constraint(function(t,e){return!e.hasOwnProperty("originId")||e.originId===n.instanceId()})}function a(t){{var n=t.__lux=t.__lux||{};n.cleanup=n.cleanup||[],n.subscriptions=n.subscriptions||{}}return n}function s(t){for(var n,e=[],r=L(t)[Symbol.iterator]();!(n=r.next()).done;){var o=_slicedToArray(n.value,2),i=o[0],a=o[1];e.push({actionType:i,waitFor:a.waitFor||[]})}return e}function c(t){t="string"==typeof t?[t]:t,t.forEach(function(t){D[t]||(D[t]=function(){var n=Array.from(arguments);F.publish({topic:"execute."+t,data:{actionType:t,actionArgs:n}})})})}function u(t){if(I[t])return o(D,I[t]);throw new Error("There is no action group named '"+t+"'")}function l(t){D=Object.assign(D,t)}function h(t,n){var e=I[t];e||(e=I[t]=[]),n="string"==typeof n?[n]:n,n.forEach(function(t){-1===e.indexOf(t)&&e.push(t)})}function p(t){var n={};n[t]=!0;var e=this.__lux,r=e.waitFor.indexOf(t);r>-1?(e.waitFor.splice(r,1),e.heardFrom.push(n),0===e.waitFor.length&&(e.heardFrom=[],this.stores.onChange.call(this,n))):this.stores.onChange.call(this,n)}function f(t){var n=this;this.__lux.waitFor=t.stores.filter(function(t){return n.stores.listenTo.indexOf(t)>-1})}function d(n){var e={mixins:[H,W].concat(n.mixins||[])};return delete n.mixins,t.createClass(Object.assign(e,n))}function g(n){var e={mixins:[W].concat(n.mixins||[])};return delete n.mixins,t.createClass(Object.assign(e,n))}function m(t){for(var n=arguments.length,e=Array(n>1?n-1:0),r=1;n>r;r++)e[r-1]=arguments[r];return 0===e.length&&(e=[q,R]),e.forEach(function(n){"function"==typeof n&&(n=n()),n.mixin&&Object.assign(t,n.mixin),n.setup.call(t),n.teardown&&t.__lux.cleanup.push(n.teardown)}),t.luxCleanup=Y,t}function v(t){return m(t,J)}function y(t){return m(t,R)}function b(t){return y(v(t))}function x(t,n,e){var r=t&&t.namespace||e.namespace;if(r in G)throw new Error(' The store namespace "'+r+'" already exists.');if(!r)throw new Error("A lux store must have a namespace value provided");if(!n||!Object.keys(n).length)throw new Error("A lux store must have action handler methods provided")}function w(t,n,e){return{waitFor:[],handler:function(){var t=0,r=Array.from(arguments);return e[n].forEach(function(n){t+=n.apply(this,r)===!1?0:1}.bind(this)),t>0}}}function _(t,n){t.waitFor&&t.waitFor.forEach(function(t){-1===n.waitFor.indexOf(t)&&n.waitFor.push(t)})}function A(t,n,e){t[n]=t[n]||[],t[n].push(e.handler||e)}function S(){for(var t=arguments.length,n=Array(t),e=0;t>e;e++)n[e]=arguments[e];var o={},i={},a={},s={};return n.forEach(function(t){var n;t&&(n=r.clone(t),r.merge(a,n.state),n.handlers&&Object.keys(n.handlers).forEach(function(t){var e=n.handlers[t];i[t]=i[t]||w(i,t,o),_(e,i[t]),A(o,t,e)}),delete n.handlers,delete n.state,r.merge(s,n))}),[a,i,s]}function E(t){G[t].dispose()}function O(t,n,e){var r=e;return t.waitFor&&t.waitFor.length&&t.waitFor.forEach(function(t){var o=n[t];if(o){var i=O(o,n,e+1);i>r&&(r=i)}}),r}function T(t,n){var e=[],r={};t.forEach(function(t){return r[t.namespace]=t}),t.forEach(function(t){return t.gen=O(t,r,0,n)});for(var o,i=L(r)[Symbol.iterator]();!(o=i.next()).done;){var a=_slicedToArray(o.value,2),s=(a[0],a[1]);e[s.gen]=e[s.gen]||[],e[s.gen].push(s)}return e}function C(t,n){var e=this;t.map(function(t){var r=Object.assign({deps:o(e.stores,t.waitFor)},n);P.publish(""+t.namespace+".handle."+n.actionType,r)})}function j(t){for(var n,e=[],r=L(I)[Symbol.iterator]();!(n=r.next()).done;){var o=_slicedToArray(n.value,2),i=o[0],a=o[1];a.indexOf(t)>=0&&e.push(i)}return e}if(!("undefined"==typeof global?window:global)._6to5Polyfill)throw new Error("You must include the 6to5 polyfill on your page before lux is loaded. See https://6to5.org/docs/usage/polyfill/ for more details.");var F=n.channel("lux.action"),k=n.channel("lux.store"),P=n.channel("lux.dispatcher"),G={},L=regeneratorRuntime.mark(function K(t){var n,e,r;return regeneratorRuntime.wrap(function(o){for(;;)switch(o.prev=o.next){case 0:-1===["object","function"].indexOf(typeof t)&&(t={}),n=Object.keys(t)[Symbol.iterator]();case 2:if((e=n.next()).done){o.next=8;break}return r=e.value,o.next=6,[r,t[r]];case 6:o.next=2;break;case 8:case"end":return o.stop()}},K,this)}),M=function(){for(var t=arguments.length,n=Array(t),e=0;t>e;e++)n[e]=arguments[e];for(var o,i,a=this,s=function(){},c=[],u=n[Symbol.iterator]();!(i=u.next()).done;){var l=i.value;c.push(r.pick(l,["handlers","state"])),delete l.handlers,delete l.state}var h=r.merge.apply(this,[{}].concat(n));return o=h&&h.hasOwnProperty("constructor")?h.constructor:function(){var t=Array.from(arguments);t[0]=t[0]||{},a.apply(this,o.mixins.concat(t))},o.mixins=c,r.merge(o,a),s.prototype=a.prototype,o.prototype=new s,h&&r.extend(o.prototype,h),o.prototype.constructor=o,o.__super__=a.prototype,o},D=Object.create(null),I={},q={setup:function(){var t=this,n=a(this),e=this.stores=this.stores||{};if(!e.listenTo)throw new Error("listenTo must contain at least one store namespace");var r="string"==typeof e.listenTo?[e.listenTo]:e.listenTo;if(!e.onChange)throw new Error("A component was told to listen to the following store(s): "+r+" but no onChange handler was implemented");n.waitFor=[],n.heardFrom=[],r.forEach(function(e){n.subscriptions[""+e+".changed"]=k.subscribe(""+e+".changed",function(){return p.call(t,e)})}),n.subscriptions.prenotify=P.subscribe("prenotify",function(n){return f.call(t,n)})},teardown:function(){for(var t,n=L(this.__lux.subscriptions)[Symbol.iterator]();!(t=n.next()).done;){var e,r=_slicedToArray(t.value,2),o=r[0],i=r[1];("prenotify"===o||(e=o.split("."))&&"changed"===e.pop())&&i.unsubscribe()}},mixin:{}},H={componentWillMount:q.setup,loadState:q.mixin.loadState,componentWillUnmount:q.teardown},R={setup:function(){var t=this;this.getActionGroup=this.getActionGroup||[],this.getActions=this.getActions||[],"string"==typeof this.getActionGroup&&(this.getActionGroup=[this.getActionGroup]),"string"==typeof this.getActions&&(this.getActions=[this.getActions]);var n=function(n,e){t[n]||(t[n]=e)};this.getActionGroup.forEach(function(t){for(var e,r=L(u(t))[Symbol.iterator]();!(e=r.next()).done;){var o=_slicedToArray(e.value,2),i=o[0],a=o[1];n(i,a)}}),this.getActions.length&&this.getActions.forEach(function(t){var e=D[t];if(!e)throw new Error("There is no action named '"+t+"'");n(t,e)})},mixin:{publishAction:function(t){for(var n=arguments.length,e=Array(n>1?n-1:0),r=1;n>r;r++)e[r-1]=arguments[r];F.publish({topic:"execute."+t,data:{actionType:t,actionArgs:e}})}}},W={componentWillMount:R.setup,publishAction:R.mixin.publishAction},J=function(){var t=void 0===arguments[0]?{}:arguments[0],n=t.handlers,e=t.handlerFn,r=t.context,o=t.channel,s=t.topic;return{setup:function(){r=r||this;var t=a(r),u=t.subscriptions;if(n=n||r.handlers,o=o||F,s=s||"execute.*",e=e||function(t){var e;(e=n[t.actionType])&&e.apply(r,t.actionArgs)},!n||!Object.keys(n).length)throw new Error("You must have at least one action handler in the handlers property");if(!u||!u.actionListener){u.actionListener=i(r,o.subscribe(s,e));var l=Object.keys(n);c(l),r.namespace&&h(r.namespace,l)}},teardown:function(){this.__lux.subscriptions.actionListener.unsubscribe()}}},Y=function(){var t=this;this.__lux.cleanup.forEach(function(n){return n.call(t)}),this.__lux.cleanup=void 0,delete this.__lux.cleanup};m.store=q,m.actionCreator=R,m.actionListener=J;var z=function(){function t(){for(var n=arguments.length,e=Array(n),r=0;n>r;r++)e[r]=arguments[r];_classCallCheck(this,t);var o=S.apply(void 0,_toArray(e)),a=_slicedToArray(o,3),c=a[0],u=a[1],l=a[2];x(l,u,this);var h=l.namespace||this.namespace;Object.assign(this,l),G[h]=this;var p=!1;this.hasChanged=!1,this.getState=function(){return c},this.setState=function(t){if(!p)throw new Error("setState can only be called during a dispatch cycle from a store action handler.");c=Object.assign(c,t)},this.flush=function(){p=!1,this.hasChanged&&(this.hasChanged=!1,k.publish(""+this.namespace+".changed"))},m(this,J({context:this,channel:P,topic:""+h+".handle.*",handlers:u,handlerFn:function(t){if(u.hasOwnProperty(t.actionType)){p=!0;var n=u[t.actionType].handler.apply(this,t.actionArgs.concat(t.deps));this.hasChanged=n===!1?!1:!0,P.publish(""+this.namespace+".handled."+t.actionType,{hasChanged:this.hasChanged,namespace:this.namespace})}}.bind(this)})),this.__subscription={notify:i(this,P.subscribe("notify",this.flush)).constraint(function(){return p})},U.registerStore({namespace:h,actions:s(u)})}return _prototypeProperties(t,null,{dispose:{value:function(){for(var t,n=L(this.__subscription)[Symbol.iterator]();!(t=n.next()).done;){var e=_slicedToArray(t.value,2),r=(e[0],e[1]);r.unsubscribe()}delete G[this.namespace],U.removeStore(this.namespace)},writable:!0,configurable:!0}}),t}();z.extend=M;var B=function(t){function n(){_classCallCheck(this,n),this.actionContext=void 0,_get(t.prototype,"constructor",this).call(this,{initialState:"ready",actionMap:{},states:{ready:{_onEnter:function(){this.actionContext=void 0},"action.dispatch":"dispatching"},dispatching:{_onEnter:function(t){this.actionContext=t,t.generations.length?(function(){for(var n,e=[],r=t.generations[Symbol.iterator]();!(n=r.next()).done;){var o=n.value;e.push(C.call(t,o,t.action))}return e}(),this.transition(t,"notifying")):this.transition(t,"nothandled")},"action.handled":function(t,n){n.hasChanged&&t.updated.push(n.namespace)},_onExit:function(t){P.publish("prenotify",{stores:t.updated})}},notifying:{_onEnter:function(t){P.publish("notify",{action:t.action})}},nothandled:{}},getStoresHandling:function(t){var n=this.actionMap[t]||[];return{stores:n,generations:T(n,t)}}}),this.createSubscribers()}return _inherits(n,t),_prototypeProperties(n,null,{handleActionDispatch:{value:function(t){var n=Object.assign({action:t,generationIndex:0,updated:[]},this.getStoresHandling(t.actionType));this.handle(n,"action.dispatch")},writable:!0,configurable:!0},registerStore:{value:function(t){for(var n,e=t.actions[Symbol.iterator]();!(n=e.next()).done;){var r,o=n.value,i=o.actionType,a={namespace:t.namespace,waitFor:o.waitFor};r=this.actionMap[i]=this.actionMap[i]||[],r.push(a)}},writable:!0,configurable:!0},removeStore:{value:function(t){for(var n,e=function(n){return n.namespace===t},r=L(this.actionMap)[Symbol.iterator]();!(n=r.next()).done;){var o=_slicedToArray(n.value,2),i=(o[0],o[1]),a=i.findIndex(e);-1!==a&&i.splice(a,1)}},writable:!0,configurable:!0},createSubscribers:{value:function(){var t=this;this.__subscriptions&&this.__subscriptions.length||(this.__subscriptions=[i(this,F.subscribe("execute.*",function(n){return t.handleActionDispatch(n)})),P.subscribe("*.handled.*",function(n){return t.handle(t.actionContext,"action.handled",n)})])},writable:!0,configurable:!0},dispose:{value:function(){this.__subscriptions.forEach(function(t){return t.unsubscribe()})},writable:!0,configurable:!0}}),n}(e.BehavioralFsm),U=new B,V={printActions:function(){var t=Object.keys(D).map(function(t){return{"action name":t,stores:U.getStoresHandling(t).stores.map(function(t){return t.namespace}).join(","),groups:j(t).join(",")}});console&&console.table?(console.group("Currently Recognized Actions"),console.table(t),console.groupEnd()):console&&console.log&&console.log(t)},printStoreDepTree:function(t){var n=[];t="string"==typeof t?[t]:t,t||(t=Object.keys(D)),t.forEach(function(t){U.getStoresHandling(t).tree.forEach(function(e){for(;e.length;){var r=e.pop();n.push({"action type":t,"store namespace":r.namespace,"waits for":r.waitFor.join(","),generation:r.gen})}}),console&&console.table?(console.group("Store Dependency List for "+t),console.table(n),console.groupEnd()):console&&console.log&&(console.log("Store Dependency List for "+t+":"),console.log(n)),n=[]})}};return{actions:D,addToActionGroup:h,component:g,controllerView:d,customActionCreator:l,dispatcher:U,getActionGroup:u,actionCreatorListener:b,actionCreator:y,actionListener:v,mixin:m,removeStore:E,Store:z,stores:G,utils:V}});