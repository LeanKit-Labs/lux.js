/**
 * lux.js - Flux-based architecture for using ReactJS at LeanKit
 * Author: Jim Cowart
 * Version: v0.2.3
 * Url: https://github.com/LeanKit-Labs/lux.js
 * License(s): MIT Copyright (c) 2014 LeanKit
 */
(function(t,n){if("function"==typeof define&&define.amd)define(["traceur","react","postal","machina"],n);else{if("object"!=typeof module||!module.exports)throw new Error("Sorry - luxJS only support AMD or CommonJS module environments.");module.exports=function(t,e,i){return n(require("traceur"),i||require("react"),t,e)}}})(this,function(t,n,e,i){function r(t){var n,e,i;return $traceurRuntime.createGeneratorInstance(function(r){for(;;)switch(r.state){case 0:"object"!=typeof t&&(t={}),r.state=10;break;case 10:n=Object.keys(t)[Symbol.iterator](),r.state=4;break;case 4:r.state=(e=n.next()).done?-2:5;break;case 5:i=e.value,r.state=6;break;case 6:return r.state=2,[i,t[i]];case 2:r.maybeThrow(),r.state=4;break;default:return r.end()}},F,this)}function s(t,n){var e=n.reduce(function(n,e){return n[e]=t[e],n},{});return e}function a(t,n){return n.withContext(t).withConstraint(function(t,n){return!n.hasOwnProperty("originId")||n.originId===e.instanceId()})}function o(t){{var n=t.__lux=t.__lux||{};n.cleanup=n.cleanup||[],n.subscriptions=n.subscriptions||{}}return n}function c(t,n){var e,i={};i[t]=n;var r=this.__lux,s=r.waitFor.indexOf(t);s>-1?(r.waitFor.splice(s,1),r.heardFrom.push(i),0===r.waitFor.length&&(i=(e=Object).assign.apply(e,$traceurRuntime.spread([{}],r.heardFrom)),r.heardFrom=[],this.stores.onChange.call(this,i))):this.stores.onChange.call(this,i)}function u(t){var n=this;this.__lux.waitFor=t.stores.filter(function(t){return n.stores.listenTo.indexOf(t)>-1})}function h(t){var e={mixins:[R,k].concat(t.mixins||[])};return delete t.mixins,n.createClass(Object.assign(e,t))}function l(t){var e={mixins:[k].concat(t.mixins||[])};return delete t.mixins,n.createClass(Object.assign(e,t))}function p(t){for(var n=[],e=1;e<arguments.length;e++)n[e-1]=arguments[e];0===n.length&&(n=[j,$,D]),n.forEach(function(n){"function"==typeof n&&(n=n()),n.mixin&&Object.assign(t,n.mixin),n.setup.call(t),t.__lux.cleanup.push(n.teardown)}),t.luxCleanup=M}function f(t){for(var n,e=[],i=r(t)[Symbol.iterator]();!(n=i.next()).done;){var s=n.value,a=s[0],o=s[1];e.push({actionType:a,waitFor:o.waitFor||[]})}return e}function d(t){return K[t]?s(I,K[t]):{}}function m(t){t="string"==typeof t?[t]:t,t.forEach(function(t){I[t]||(I[t]=function(){var n=Array.from(arguments);S.publish({topic:"execute."+t,data:{actionType:t,actionArgs:n}})})})}function v(t){I=Object.assign(I,t)}function b(t,n){K[t]=n}function g(t,n,e,i,r){e[i]=function(){for(var e,i=[],s=0;s<arguments.length;s++)i[s]=arguments[s];r.apply(t,(e=[n]).concat.apply(e,$traceurRuntime.spread(i)))}}function y(t,n,e){for(var i,s={},a=r(e)[Symbol.iterator]();!(i=a.next()).done;){var o=i.value,c=o[0],u=o[1];g(t,n,s,c,"object"==typeof u?u.handler:u)}return s}function x(t){if(!t.namespace)throw new Error("A lux store must have a namespace value provided");if(!t.handlers)throw new Error("A lux store must have action handler methods provided")}function _(t){O[t].dispose()}function w(t,n){var e=this;t.map(function(t){var i=Object.assign({deps:s(e.stores,t.waitFor)},n);T.publish(t.namespace+".handle."+n.actionType,i)})}function A(t,n,e){e=e||0;var i=e;return t.waitFor&&t.waitFor.length&&t.waitFor.forEach(function(t){var r=n[t],s=A(r,n,e+1);s>i&&(i=s)}),i}function C(t){var n=[],e={};t.forEach(function(t){return e[t.namespace]=t}),t.forEach(function(t){return t.gen=A(t,e)});for(var i,s=r(e)[Symbol.iterator]();!(i=s.next()).done;){var a=i.value,o=(a[0],a[1]);n[o.gen]=n[o.gen]||[],n[o.gen].push(o)}return n}var F=$traceurRuntime.initGeneratorFunction(r),S=e.channel("lux.action"),E=e.channel("lux.store"),T=e.channel("lux.dispatcher"),O={},j={setup:function(){var t=this,n=o(this),e=this.stores=this.stores||{},i="string"==typeof e.listenTo?[e.listenTo]:e.listenTo,s=function(t){if("function"==typeof this.setState){for(var n,e={},i=r(t)[Symbol.iterator]();!(n=i.next()).done;){var s=n.value,a=s[0],o=s[1];e[a]=o.state}this.setState(e)}};n.waitFor=[],n.heardFrom=[],e.onChange=e.onChange||s,i.forEach(function(e){n.subscriptions[e+".changed"]=E.subscribe(e+".changed",function(n){return c.call(t,e,n)})}),n.subscriptions.prenotify=T.subscribe("prenotify",function(n){return u.call(t,n)})},teardown:function(){for(var t,n=r(this.__lux.subscriptions)[Symbol.iterator]();!(t=n.next()).done;){var e,i=t.value,s=i[0],a=i[1];("prenotify"===s||(e=s.split(".")&&"changed"===e[1]))&&a.unsubscribe()}},mixin:{}},R={componentWillMount:j.setup,loadState:j.mixin.loadState,componentWillUnmount:j.teardown},$={setup:function(){this.getActionsFor=this.getActionsFor||[],this.getActions=this.getActions||[],this.getActionsFor.forEach(function(t){for(var n,e=r(d(t))[Symbol.iterator]();!(n=e.next()).done;){var i=n.value,s=i[0],a=i[1];this[s]||(this[s]=a)}}.bind(this))}},k={componentWillMount:$.setup},D=function(){var t=void 0!==arguments[0]?arguments[0]:{},n=t.handlers,e=t.handlerFn,i=t.context,r=t.channel,s=t.topic;return{setup:function(){i=i||this;var t=o(i),c=t.subscriptions;n=n||i.handlers,r=r||S,s=s||"execute.*",e=e||function(t){var e;(e=n[t.actionType])&&e.apply(i,t.actionArgs)},!n||c&&c.actionListener||(c.actionListener=a(i,r.subscribe(s,e)))},teardown:function(){this.__lux.subscriptions.actionListener.unsubscribe()}}},M=function(){var t=this;this.__lux.cleanup.forEach(function(n){return n.call(t)}),this.__lux.cleanup=void 0,delete this.__lux.cleanup};p.store=j,p.actionDispatcher=$,p.actionListener=D;var I={},K={},L=function(t){"use strict";var n=this;x(t);var e=t.namespace;if(e in O)throw new Error(' The store namespace "'+e+'" already exists.');O[e]=this;var i=t.stateProp||"state",r=t[i]||{},s=y(this,r,t.handlers);delete t.handlers,delete t.state,this.changedKeys=[],Object.assign(this,t),this.inDispatch=!1,this.hasChanged=!1,this.getState=function(){return r},this.flush=function(){this.inDispatch=!1;var t=Object.keys(this.changedKeys);this.changedKeys={},this.hasChanged=!1,E.publish(this.namespace+".changed",{changedKeys:t,state:r})},p(this,D({context:this,channel:T,topic:e+".handle.*",handlers:s,handlerFn:function(t){s.hasOwnProperty(t.actionType)&&(this.inDispatch=!0,s[t.actionType].call(this,t.actionArgs.concat(t.deps)),T.publish(this.namespace+".handled."+t.actionType,{hasChanged:this.hasChanged,namespace:this.namespace}))}.bind(this)})),this.__subscription={notify:a(this,T.subscribe("notify",this.flush)).withConstraint(function(){return n.inDispatch})},m(Object.keys(s)),lux.dispatcher.registerStore({namespace:e,actions:f(s)})};$traceurRuntime.createClass(L,{dispose:function(){"use strict";for(var t,n=r(this.__subscription)[Symbol.iterator]();!(t=n.next()).done;){var e=t.value,i=(e[0],e[1]);i.unsubscribe()}delete O[this.namespace]}},{});var G=function(t){"use strict";var n=this;Object.assign(this,{generationIndex:0,stores:{},updated:[]},t),this.__subscriptions={handled:T.subscribe("*.handled.*",function(t){return n.handle("action.handled",t)})},$traceurRuntime.superCall(this,P.prototype,"constructor",[{initialState:"uninitialized",states:{uninitialized:{start:"dispatching"},dispatching:{_onEnter:function(){var n=this;try{(function(){for(var e,i=0,r=[],s=t.generations[Symbol.iterator]();!(e=s.next()).done;){var a=e.value;r[i++]=w.call(n,a,t.action)}return r})()}catch(e){this.err=e,console.log(e),this.transition("failure")}this.transition("success")},"action.handled":function(t){this.updated.push(t.namespace)},_onExit:function(){T.publish("prenotify",{stores:this.updated})}},success:{_onEnter:function(){T.publish("notify",{action:this.action}),this.emit("success")}},failure:{_onEnter:function(){T.publish("notify",{action:this.action}),T.publish("action.failure",{action:this.action,err:this.err}),this.emit("failure")}}}}])},P=G;$traceurRuntime.createClass(G,{success:function(t){"use strict";var n=this;return this.on("success",t),this._started||(setTimeout(function(){return n.handle("start")},0),this._started=!0),this},failure:function(t){"use strict";var n=this;return this.on("error",t),this._started||(setTimeout(function(){return n.handle("start")},0),this._started=!0),this}},{},i.Fsm);var U=function(){"use strict";var t=this;$traceurRuntime.superCall(this,W.prototype,"constructor",[{initialState:"ready",actionMap:{},coordinators:[],states:{ready:{_onEnter:function(){this.luxAction={}},"action.dispatch":function(t){this.luxAction={action:t},this.transition("preparing")},"register.store":function(t){for(var n,e=t.actions[Symbol.iterator]();!(n=e.next()).done;){var i,r=n.value,s=r.actionType,a={namespace:t.namespace,waitFor:r.waitFor};i=this.actionMap[s]=this.actionMap[s]||[],i.push(a)}}},preparing:{_onEnter:function(){var t=this.luxAction.stores=this.actionMap[this.luxAction.action.actionType]||[];this.luxAction.generations=C(t),this.transition(this.luxAction.generations.length?"dispatching":"ready")},"*":function(){this.deferUntilTransition("ready")}},dispatching:{_onEnter:function(){var t=this,n=this.luxAction.coordinator=new G({generations:this.luxAction.generations,action:this.luxAction.action});n.success(function(){return t.transition("ready")}).failure(function(){return t.transition("ready")})},"*":function(){this.deferUntilTransition("ready")}},stopped:{}}}]),this.__subscriptions=[a(this,S.subscribe("execute.*",function(n){return t.handleActionDispatch(n)}))]},W=U;$traceurRuntime.createClass(U,{handleActionDispatch:function(t){"use strict";this.handle("action.dispatch",t)},registerStore:function(t){"use strict";this.handle("register.store",t)},dispose:function(){"use strict";this.transition("stopped"),this.__subscriptions.forEach(function(t){return t.unsubscribe()})}},{},i.Fsm);var q=new U;return{ActionCoordinator:G,actionCreators:I,createActionGroup:b,createComponent:l,createControllerView:h,customActionCreator:v,dispatcher:q,getActionCreatorFor:d,mixin:p,removeStore:_,Store:L}});