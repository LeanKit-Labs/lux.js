/**
 * lux.js - Flux-based architecture for using ReactJS at LeanKit
 * Author: Jim Cowart
 * Version: v0.3.0-RC1
 * Url: https://github.com/LeanKit-Labs/lux.js
 * License(s): MIT Copyright (c) 2014 LeanKit
 */
(function(t,n){if("function"==typeof define&&define.amd)define(["traceur","react","postal","machina"],n);else{if("object"!=typeof module||!module.exports)throw new Error("Sorry - luxJS only support AMD or CommonJS module environments.");module.exports=function(t,e,i){return n(require("traceur"),i||require("react"),t,e)}}})(this,function(t,n,e,i){function r(t){var n,e,i;return $traceurRuntime.createGeneratorInstance(function(r){for(;;)switch(r.state){case 0:"object"!=typeof t&&(t={}),r.state=10;break;case 10:n=Object.keys(t)[Symbol.iterator](),r.state=4;break;case 4:r.state=(e=n.next()).done?-2:5;break;case 5:i=e.value,r.state=6;break;case 6:return r.state=2,[i,t[i]];case 2:r.maybeThrow(),r.state=4;break;default:return r.end()}},F,this)}function o(t,n){var e=n.reduce(function(n,e){return n[e]=t[e],n},{});return e}function s(t,n){return n.withContext(t).withConstraint(function(t,n){return!n.hasOwnProperty("originId")||n.originId===e.instanceId()})}function a(t){{var n=t.__lux=t.__lux||{};n.cleanup=n.cleanup||[],n.subscriptions=n.subscriptions||{}}return n}function c(t){for(var n,e=[],i=r(t)[Symbol.iterator]();!(n=i.next()).done;){var o=n.value,s=o[0],a=o[1];console.log(s,a),e.push({actionType:s,waitFor:a.waitFor||[]})}return e}function u(t){t="string"==typeof t?[t]:t,t.forEach(function(t){R[t]||(R[t]=function(){var n=Array.from(arguments);T.publish({topic:"execute."+t,data:{actionType:t,actionArgs:n}})})})}function h(t){return D[t]?o(R,D[t]):{}}function l(t){R=Object.assign(R,t)}function f(t,n){var e=D[t];e||(e=D[t]=[]),n="string"==typeof n?[n]:n,n.forEach(function(t){-1===e.indexOf(t)&&e.push(t)})}function p(t){var n={};n[t]=!0;var e=this.__lux,i=e.waitFor.indexOf(t);i>-1?(e.waitFor.splice(i,1),e.heardFrom.push(n),0===e.waitFor.length&&(e.heardFrom=[],this.stores.onChange.call(this,n))):this.stores.onChange.call(this,n)}function d(t){var n=this;this.__lux.waitFor=t.stores.filter(function(t){return n.stores.listenTo.indexOf(t)>-1})}function g(t){var e={mixins:[G,M].concat(t.mixins||[])};return delete t.mixins,n.createClass(Object.assign(e,t))}function m(t){var e={mixins:[M].concat(t.mixins||[])};return delete t.mixins,n.createClass(Object.assign(e,t))}function v(t){for(var n=[],e=1;e<arguments.length;e++)n[e-1]=arguments[e];0===n.length&&(n=[$,L]),n.forEach(function(n){"function"==typeof n&&(n=n()),n.mixin&&Object.assign(t,n.mixin),n.setup.call(t),n.teardown&&t.__lux.cleanup.push(n.teardown)}),t.luxCleanup=H}function b(t){return v(t,I),t}function y(t){return v(t,L),t}function x(t,n,e,i){n[e]=function(){for(var n,e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];return(n=i).apply.apply(n,$traceurRuntime.spread([t],e))}}function w(t,n){for(var e,i={},o=r(n)[Symbol.iterator]();!(e=o.next()).done;){var s=e.value,a=s[0],c=s[1];x(t,i,a,"object"==typeof c?c.handler:c)}return i}function _(t){if(t.namespace in k)throw new Error(' The store namespace "'+t.namespace+'" already exists.');if(!t.namespace)throw new Error("A lux store must have a namespace value provided");if(!t.handlers)throw new Error("A lux store must have action handler methods provided")}function A(t){k[t].dispose()}function S(t,n){var e=this;t.map(function(t){var i=Object.assign({deps:o(e.stores,t.waitFor)},n);O.publish(t.namespace+".handle."+n.actionType,i)})}function C(t,n,e){var i=e;return t.waitFor&&t.waitFor.length&&t.waitFor.forEach(function(t){var r=n[t];if(r){var o=C(r,n,e+1);o>i&&(i=o)}}),i}function E(t,n){var e=[],i={};t.forEach(function(t){return i[t.namespace]=t}),t.forEach(function(t){return t.gen=C(t,i,0,n)});for(var o,s=r(i)[Symbol.iterator]();!(o=s.next()).done;){var a=o.value,c=(a[0],a[1]);e[c.gen]=e[c.gen]||[],e[c.gen].push(c)}return e}var F=$traceurRuntime.initGeneratorFunction(r),T=e.channel("lux.action"),j=e.channel("lux.store"),O=e.channel("lux.dispatcher"),k={},R=Object.create(null),D={},$={setup:function(){var t=this,n=a(this),e=this.stores=this.stores||{},i="string"==typeof e.listenTo?[e.listenTo]:e.listenTo,r=function(){throw new Error("A component was told to listen to the following store(s): "+i+" but no onChange handler was implemented")};n.waitFor=[],n.heardFrom=[],e.onChange=e.onChange||r,i.forEach(function(e){n.subscriptions[e+".changed"]=j.subscribe(e+".changed",function(){return p.call(t,e)})}),n.subscriptions.prenotify=O.subscribe("prenotify",function(n){return d.call(t,n)})},teardown:function(){for(var t,n=r(this.__lux.subscriptions)[Symbol.iterator]();!(t=n.next()).done;){var e,i=t.value,o=i[0],s=i[1];("prenotify"===o||(e=o.split(".")&&"changed"===e[1]))&&s.unsubscribe()}},mixin:{}},G={componentWillMount:$.setup,loadState:$.mixin.loadState,componentWillUnmount:$.teardown},L={setup:function(){var t=this;this.getActionGroup=this.getActionGroup||[],this.getActions=this.getActions||[];var n=function(n,e){t[n]||(t[n]=e)};if(this.getActionGroup.forEach(function(t){for(var e,i=r(h(t))[Symbol.iterator]();!(e=i.next()).done;){var o=e.value,s=o[0],a=o[1];n(s,a)}}),this.getActions.length)for(var e,i=r(o(R,this.getActions))[Symbol.iterator]();!(e=i.next()).done;){var s=e.value,a=s[0],c=s[1];n(a,c)}},mixin:{dispatchAction:function(t){for(var n=[],e=1;e<arguments.length;e++)n[e-1]=arguments[e];T.publish({topic:"execute."+t,data:{actionType:t,actionArgs:n}})}}},M={componentWillMount:L.setup},I=function(){var t=void 0!==arguments[0]?arguments[0]:{},n=t.handlers,e=t.handlerFn,i=t.context,r=t.channel,o=t.topic;return{setup:function(){i=i||this;var t=a(i),c=t.subscriptions;n=n||i.handlers,r=r||T,o=o||"execute.*",e=e||function(t){var e;(e=n[t.actionType])&&e.apply(i,t.actionArgs)},!n||c&&c.actionListener||(c.actionListener=s(i,r.subscribe(o,e)),u(Object.keys(n)))},teardown:function(){this.__lux.subscriptions.actionListener.unsubscribe()}}},H=function(){var t=this;this.__lux.cleanup.forEach(function(n){return n.call(t)}),this.__lux.cleanup=void 0,delete this.__lux.cleanup};v.store=$,v.actionDispatcher=L,v.actionListener=I;var z=function(t){"use strict";_(t);var n=t.namespace,e=t.stateProp||"state",i=t[e]||{},r=w(this,t.handlers);k[n]=this;var o=!1;this.hasChanged=!1,this.getState=function(){return i},this.setState=function(t){if(!o)throw new Error("setState can only be called during a dispatch cycle from a store action handler.");i=Object.assign(i,t)},this.flush=function(){o=!1,this.hasChanged&&(this.hasChanged=!1,j.publish(this.namespace+".changed"))},v(this,I({context:this,channel:O,topic:n+".handle.*",handlers:r,handlerFn:function(t){if(r.hasOwnProperty(t.actionType)){o=!0;var n=r[t.actionType].call(this,t.actionArgs.concat(t.deps));this.hasChanged=n===!1?!1:!0,O.publish(this.namespace+".handled."+t.actionType,{hasChanged:this.hasChanged,namespace:this.namespace})}}.bind(this)})),this.__subscription={notify:s(this,O.subscribe("notify",this.flush)).withConstraint(function(){return o})},u(Object.keys(r)),J.registerStore({namespace:n,actions:c(t.handlers)}),delete t.handlers,delete t.state,Object.assign(this,t)};$traceurRuntime.createClass(z,{dispose:function(){"use strict";for(var t,n=r(this.__subscription)[Symbol.iterator]();!(t=n.next()).done;){var e=t.value,i=(e[0],e[1]);i.unsubscribe()}delete k[this.namespace]}},{});var P=function(t){"use strict";var n=this;Object.assign(this,{generationIndex:0,stores:{},updated:[]},t),this.__subscriptions={handled:O.subscribe("*.handled.*",function(t){return n.handle("action.handled",t)})},$traceurRuntime.superCall(this,U.prototype,"constructor",[{initialState:"uninitialized",states:{uninitialized:{start:"dispatching"},dispatching:{_onEnter:function(){var n=this;try{(function(){for(var e,i=0,r=[],o=t.generations[Symbol.iterator]();!(e=o.next()).done;){var s=e.value;r[i++]=S.call(n,s,t.action)}return r})()}catch(e){this.err=e,console.log(e),this.transition("failure")}this.transition("success")},"action.handled":function(t){t.hasChanged&&this.updated.push(t.namespace)},_onExit:function(){O.publish("prenotify",{stores:this.updated})}},success:{_onEnter:function(){O.publish("notify",{action:this.action}),this.emit("success")}},failure:{_onEnter:function(){O.publish("notify",{action:this.action}),O.publish("action.failure",{action:this.action,err:this.err}),this.emit("failure")}}}}])},U=P;$traceurRuntime.createClass(P,{success:function(t){"use strict";var n=this;return this.on("success",t),this._started||(setTimeout(function(){return n.handle("start")},0),this._started=!0),this},failure:function(t){"use strict";var n=this;return this.on("error",t),this._started||(setTimeout(function(){return n.handle("start")},0),this._started=!0),this}},{},i.Fsm);var W=function(){"use strict";var t=this;$traceurRuntime.superCall(this,q.prototype,"constructor",[{initialState:"ready",actionMap:{},coordinators:[],states:{ready:{_onEnter:function(){this.luxAction={}},"action.dispatch":function(t){this.luxAction={action:t},this.transition("preparing")},"register.store":function(t){for(var n,e=t.actions[Symbol.iterator]();!(n=e.next()).done;){var i,r=n.value,o=r.actionType,s={namespace:t.namespace,waitFor:r.waitFor};i=this.actionMap[o]=this.actionMap[o]||[],i.push(s)}}},preparing:{_onEnter:function(){var t=this.getStoresHandling(this.luxAction.action.actionType);this.luxAction.stores=t.stores,this.luxAction.generations=t.tree,this.transition(this.luxAction.generations.length?"dispatching":"ready")},"*":function(){this.deferUntilTransition("ready")}},dispatching:{_onEnter:function(){var t=this,n=this.luxAction.coordinator=new P({generations:this.luxAction.generations,action:this.luxAction.action});n.success(function(){return t.transition("ready")}).failure(function(){return t.transition("ready")})},"*":function(){this.deferUntilTransition("ready")}},stopped:{}},getStoresHandling:function(t){var n=this.actionMap[t]||[];return{stores:n,tree:E(n,t)}}}]),this.__subscriptions=[s(this,T.subscribe("execute.*",function(n){return t.handleActionDispatch(n)}))]},q=W;$traceurRuntime.createClass(W,{handleActionDispatch:function(t){"use strict";this.handle("action.dispatch",t)},registerStore:function(t){"use strict";this.handle("register.store",t)},dispose:function(){"use strict";this.transition("stopped"),this.__subscriptions.forEach(function(t){return t.unsubscribe()})}},{},i.Fsm);var J=new W,V={printActions:function(){var t=Object.keys(R).map(function(t){return{"action name":t,stores:J.getStoresHandling(t).stores.map(function(t){return t.namespace}).join(",")}});console&&console.table?(console.group("Currently Recognized Actions"),console.table(t),console.groupEnd()):console&&console.log&&console.log(t)},printStoreDepTree:function(t){var n=[];t="string"==typeof t?[t]:t,t||(t=Object.keys(R)),t.forEach(function(t){J.getStoresHandling(t).tree.forEach(function(e){for(;e.length;){var i=e.pop();n.push({"action type":t,"store namespace":i.namespace,"waits for":i.waitFor.join(","),generation:i.gen})}}),console&&console.table?(console.group("Store Dependency List for "+t),console.table(n),console.groupEnd()):console&&console.log&&(console.log("Store Dependency List for "+t+":"),console.log(n)),n=[]})}};return{actionCreators:R,addToActionGroup:f,component:m,controllerView:g,customActionCreator:l,dispatcher:J,getActionGroup:h,actionDispatcher:y,actionListener:b,mixin:v,removeStore:A,Store:z,stores:k,utils:V}});