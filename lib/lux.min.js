/**
 * lux.js - Flux-based architecture for using ReactJS at LeanKit
 * Author: Jim Cowart
 * Version: v0.6.1
 * Url: https://github.com/LeanKit-Labs/lux.js
 * License(s): MIT Copyright (c) 2014 LeanKit
 */
"use strict";var _slicedToArray=function(t,e){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t)){for(var n,o=[],r=t[Symbol.iterator]();!(n=r.next()).done&&(o.push(n.value),!e||o.length!==e););return o}throw new TypeError("Invalid attempt to destructure non-iterable instance")},_get=function t(e,n,o){var r=Object.getOwnPropertyDescriptor(e,n);if(void 0===r){var i=Object.getPrototypeOf(e);return null===i?void 0:t(i,n,o)}if("value"in r&&r.writable)return r.value;var a=r.get;return void 0===a?void 0:a.call(o)},_inherits=function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(t.__proto__=e)},_prototypeProperties=function(t,e,n){e&&Object.defineProperties(t,e),n&&Object.defineProperties(t.prototype,n)},_classCallCheck=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")};(function(t,e){"function"==typeof define&&define.amd?define(["react","postal","machina","lodash"],e):"object"==typeof module&&module.exports?module.exports=function(t,n,o,r){return e(t||require("react"),n||require("postal"),o||require("machina"),r||require("lodash"))}:t.lux=e(t.React,t.postal,t.machina,t._)})(void 0,function(t,e,n,o){function r(t,n){return n.context(t).constraint(function(t,n){return!n.hasOwnProperty("originId")||n.originId===e.instanceId()})}function i(t){{var e=t.__lux=t.__lux||{};e.cleanup=e.cleanup||[],e.subscriptions=e.subscriptions||{}}return e}function a(t){for(var e,n=[],o=L(t)[Symbol.iterator]();!(e=o.next()).done;){var r=_slicedToArray(e.value,2),i=r[0],a=r[1];n.push({actionType:i,waitFor:a.waitFor||[]})}return n}function s(t){t="string"==typeof t?[t]:t,t.forEach(function(t){D[t]||(D[t]=function(){var e=Array.from(arguments);C.publish({topic:"execute."+t,data:{actionType:t,actionArgs:e}})})})}function c(t){if(M[t])return o.pick(D,M[t]);throw new Error("There is no action group named '"+t+"'")}function u(t){D=Object.assign(D,t)}function l(t,e){var n=M[t];n||(n=M[t]=[]),e="string"==typeof e?[e]:e;var r=o.difference(e,Object.keys(D));if(r.length)throw new Error("The following actions do not exist: "+r.join(", "));e.forEach(function(t){-1===n.indexOf(t)&&n.push(t)})}function h(t){var e={};e[t]=!0;var n=this.__lux,o=n.waitFor.indexOf(t);o>-1?(n.waitFor.splice(o,1),n.heardFrom.push(e),0===n.waitFor.length&&(n.heardFrom=[],this.stores.onChange.call(this,e))):this.stores.onChange.call(this,e)}function p(t){var e=this;this.__lux.waitFor=t.stores.filter(function(t){return e.stores.listenTo.indexOf(t)>-1})}function f(e){var n={mixins:[q,R].concat(e.mixins||[])};return delete e.mixins,t.createClass(Object.assign(n,e))}function d(e){var n={mixins:[R].concat(e.mixins||[])};return delete e.mixins,t.createClass(Object.assign(n,e))}function g(t){for(var e=arguments.length,n=Array(e>1?e-1:0),o=1;e>o;o++)n[o-1]=arguments[o];return 0===n.length&&(n=[I,H]),n.forEach(function(e){if("function"==typeof e&&(e=e()),e.mixin&&Object.assign(t,e.mixin),"function"!=typeof e.setup)throw new Error("Lux mixins should have a setup method. Did you perhaps pass your mixins ahead of your target instance?");e.setup.call(t),e.teardown&&t.__lux.cleanup.push(e.teardown)}),t.luxCleanup=Y,t}function b(t){return g(t,W)}function m(t){return g(t,H)}function y(t){return m(b(t))}function v(t,e,n){var o=t&&t.namespace||n.namespace;if(o in P)throw new Error('The store namespace "'+o+'" already exists.');if(!o)throw new Error("A lux store must have a namespace value provided");if(!e||!Object.keys(e).length)throw new Error("A lux store must have action handler methods provided")}function x(t,e,n){return{waitFor:[],handler:function(){var t=0,o=Array.from(arguments);return n[e].forEach(function(e){t+=e.apply(this,o)===!1?0:1}.bind(this)),t>0}}}function w(t,e){t.waitFor&&t.waitFor.forEach(function(t){-1===e.waitFor.indexOf(t)&&e.waitFor.push(t)})}function _(t,e,n){t[e]=t[e]||[],t[e].push(n.handler||n)}function A(){for(var t=arguments.length,e=Array(t),n=0;t>n;n++)e[n]=arguments[n];var r={},i={},a={},s={};return e.forEach(function(t){var e;t&&(e=o.clone(t),o.merge(a,e.state),e.handlers&&Object.keys(e.handlers).forEach(function(t){var n=e.handlers[t];i[t]=i[t]||x(i,t,r),w(n,i[t]),_(r,t,n)}),delete e.handlers,delete e.state,o.merge(s,e))}),[a,i,s]}function E(t){P[t].dispose()}function O(t,e,n){var o=n;return t.waitFor&&t.waitFor.length&&t.waitFor.forEach(function(t){var r=e[t];if(r){var i=O(r,e,n+1);i>o&&(o=i)}}),o}function S(t,e){var n=[],o={};t.forEach(function(t){return o[t.namespace]=t}),t.forEach(function(t){return t.gen=O(t,o,0,e)});for(var r,i=L(o)[Symbol.iterator]();!(r=i.next()).done;){var a=_slicedToArray(r.value,2),s=(a[0],a[1]);n[s.gen]=n[s.gen]||[],n[s.gen].push(s)}return n}function T(t,e){var n=this;t.map(function(t){var r=Object.assign({deps:o.pick(n.stores,t.waitFor)},e);k.publish(""+t.namespace+".handle."+e.actionType,r)})}function j(t){for(var e,n=[],o=L(M)[Symbol.iterator]();!(e=o.next()).done;){var r=_slicedToArray(e.value,2),i=r[0],a=r[1];a.indexOf(t)>=0&&n.push(i)}return n}if(!("undefined"==typeof global?window:global)._babelPolyfill)throw new Error("You must include the babel polyfill on your page before lux is loaded. See https://babeljs.io/docs/usage/polyfill/ for more details.");var C=e.channel("lux.action"),F=e.channel("lux.store"),k=e.channel("lux.dispatcher"),P={},L=regeneratorRuntime.mark(function J(t){var e,n,o;return regeneratorRuntime.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:-1===["object","function"].indexOf(typeof t)&&(t={}),e=Object.keys(t)[Symbol.iterator]();case 2:if((n=e.next()).done){r.next=8;break}return o=n.value,r.next=6,[o,t[o]];case 6:r.next=2;break;case 8:case"end":return r.stop()}},J,this)}),G=function(){for(var t=arguments.length,e=Array(t),n=0;t>n;n++)e[n]=arguments[n];for(var r,i,a=this,s=function(){},c=[],u=e[Symbol.iterator]();!(i=u.next()).done;){var l=i.value;c.push(o.pick(l,["handlers","state"])),delete l.handlers,delete l.state}var h=o.merge.apply(this,[{}].concat(e));return r=h&&h.hasOwnProperty("constructor")?h.constructor:function(){var t=Array.from(arguments);t[0]=t[0]||{},a.apply(this,r.mixins.concat(t))},r.mixins=c,o.merge(r,a),s.prototype=a.prototype,r.prototype=new s,h&&o.extend(r.prototype,h),r.prototype.constructor=r,r.__super__=a.prototype,r},D=Object.create(null),M={},I={setup:function(){var t=this,e=i(this),n=this.stores=this.stores||{};if(!n.listenTo||!n.listenTo.length)throw new Error("listenTo must contain at least one store namespace");var o="string"==typeof n.listenTo?[n.listenTo]:n.listenTo;if(!n.onChange)throw new Error("A component was told to listen to the following store(s): "+o+" but no onChange handler was implemented");e.waitFor=[],e.heardFrom=[],o.forEach(function(n){e.subscriptions[""+n+".changed"]=F.subscribe(""+n+".changed",function(){return h.call(t,n)})}),e.subscriptions.prenotify=k.subscribe("prenotify",function(e){return p.call(t,e)})},teardown:function(){for(var t,e=L(this.__lux.subscriptions)[Symbol.iterator]();!(t=e.next()).done;){var n,o=_slicedToArray(t.value,2),r=o[0],i=o[1];("prenotify"===r||(n=r.split("."))&&"changed"===n.pop())&&i.unsubscribe()}},mixin:{}},q={componentWillMount:I.setup,loadState:I.mixin.loadState,componentWillUnmount:I.teardown},H={setup:function(){var t=this;this.getActionGroup=this.getActionGroup||[],this.getActions=this.getActions||[],"string"==typeof this.getActionGroup&&(this.getActionGroup=[this.getActionGroup]),"string"==typeof this.getActions&&(this.getActions=[this.getActions]);var e=function(e,n){t[e]||(t[e]=n)};this.getActionGroup.forEach(function(t){for(var n,o=L(c(t))[Symbol.iterator]();!(n=o.next()).done;){var r=_slicedToArray(n.value,2),i=r[0],a=r[1];e(i,a)}}),this.getActions.length&&this.getActions.forEach(function(t){var n=D[t];if(!n)throw new Error("There is no action named '"+t+"'");e(t,n)})},mixin:{publishAction:function(t){for(var e=arguments.length,n=Array(e>1?e-1:0),o=1;e>o;o++)n[o-1]=arguments[o];C.publish({topic:"execute."+t,data:{actionType:t,actionArgs:n}})}}},R={componentWillMount:H.setup,publishAction:H.mixin.publishAction},W=function(){var t=void 0===arguments[0]?{}:arguments[0],e=t.handlers,n=t.handlerFn,o=t.context,a=t.channel,c=t.topic;return{setup:function(){o=o||this;var t=i(o),u=t.subscriptions;if(e=e||o.handlers,a=a||C,c=c||"execute.*",n=n||function(t){var n;(n=e[t.actionType])&&n.apply(o,t.actionArgs)},!e||!Object.keys(e).length)throw new Error("You must have at least one action handler in the handlers property");if(!u||!u.actionListener){u.actionListener=r(o,a.subscribe(c,n));var h=Object.keys(e);s(h),o.namespace&&l(o.namespace,h)}},teardown:function(){this.__lux.subscriptions.actionListener.unsubscribe()}}},Y=function(){var t=this;this.__lux.cleanup.forEach(function(e){return e.call(t)}),this.__lux.cleanup=void 0,delete this.__lux.cleanup};g.store=I,g.actionCreator=H,g.actionListener=W;var z=function(){function t(){for(var e=arguments.length,n=Array(e),o=0;e>o;o++)n[o]=arguments[o];_classCallCheck(this,t);var i=A.apply(void 0,n),s=_slicedToArray(i,3),c=s[0],u=s[1],l=s[2];v(l,u,this);var h=l.namespace||this.namespace;Object.assign(this,l),P[h]=this;var p=!1;this.hasChanged=!1,this.getState=function(){return c},this.setState=function(t){if(!p)throw new Error("setState can only be called during a dispatch cycle from a store action handler.");c=Object.assign(c,t)},this.replaceState=function(t){if(!p)throw new Error("replaceState can only be called during a dispatch cycle from a store action handler.");Object.keys(c).forEach(function(t){delete c[t]}),c=Object.assign(c,t)},this.flush=function(){p=!1,this.hasChanged&&(this.hasChanged=!1,F.publish(""+this.namespace+".changed"))},g(this,W({context:this,channel:k,topic:""+h+".handle.*",handlers:u,handlerFn:function(t){if(u.hasOwnProperty(t.actionType)){p=!0;var e=u[t.actionType].handler.apply(this,t.actionArgs.concat(t.deps));this.hasChanged=e===!1?!1:!0,k.publish(""+this.namespace+".handled."+t.actionType,{hasChanged:this.hasChanged,namespace:this.namespace})}}.bind(this)})),this.__subscription={notify:r(this,k.subscribe("notify",this.flush)).constraint(function(){return p})},U.registerStore({namespace:h,actions:a(u)})}return _prototypeProperties(t,null,{dispose:{value:function(){for(var t,e=L(this.__subscription)[Symbol.iterator]();!(t=e.next()).done;){var n=_slicedToArray(t.value,2),o=(n[0],n[1]);o.unsubscribe()}delete P[this.namespace],U.removeStore(this.namespace),this.luxCleanup()},writable:!0,configurable:!0}}),t}();z.extend=G;var B=function(t){function e(){_classCallCheck(this,e),this.actionContext=void 0,_get(Object.getPrototypeOf(e.prototype),"constructor",this).call(this,{initialState:"ready",actionMap:{},states:{ready:{_onEnter:function(){this.actionContext=void 0},"action.dispatch":"dispatching"},dispatching:{_onEnter:function(t){this.actionContext=t,t.generations.length?(function(){for(var e,n=[],o=t.generations[Symbol.iterator]();!(e=o.next()).done;){var r=e.value;n.push(T.call(t,r,t.action))}return n}(),this.transition(t,"notifying")):this.transition(t,"nothandled")},"action.handled":function(t,e){e.hasChanged&&t.updated.push(e.namespace)},_onExit:function(t){k.publish("prenotify",{stores:t.updated})}},notifying:{_onEnter:function(t){k.publish("notify",{action:t.action})}},nothandled:{}},getStoresHandling:function(t){var e=this.actionMap[t]||[];return{stores:e,generations:S(e,t)}}}),this.createSubscribers()}return _inherits(e,t),_prototypeProperties(e,null,{handleActionDispatch:{value:function(t){var e=Object.assign({action:t,generationIndex:0,updated:[]},this.getStoresHandling(t.actionType));this.handle(e,"action.dispatch")},writable:!0,configurable:!0},registerStore:{value:function(t){for(var e,n=t.actions[Symbol.iterator]();!(e=n.next()).done;){var o,r=e.value,i=r.actionType,a={namespace:t.namespace,waitFor:r.waitFor};o=this.actionMap[i]=this.actionMap[i]||[],o.push(a)}},writable:!0,configurable:!0},removeStore:{value:function(t){for(var e,n=function(e){return e.namespace===t},o=L(this.actionMap)[Symbol.iterator]();!(e=o.next()).done;){var r=_slicedToArray(e.value,2),i=(r[0],r[1]),a=i.findIndex(n);-1!==a&&i.splice(a,1)}},writable:!0,configurable:!0},createSubscribers:{value:function(){var t=this;this.__subscriptions&&this.__subscriptions.length||(this.__subscriptions=[r(this,C.subscribe("execute.*",function(e){return t.handleActionDispatch(e)})),k.subscribe("*.handled.*",function(e){return t.handle(t.actionContext,"action.handled",e)}).constraint(function(){return!!t.actionContext})])},writable:!0,configurable:!0},dispose:{value:function(){this.__subscriptions&&(this.__subscriptions.forEach(function(t){return t.unsubscribe()}),this.__subscriptions=null)},writable:!0,configurable:!0}}),e}(n.BehavioralFsm),U=new B,V={printActions:function(){var t=Object.keys(D).map(function(t){return{"action name":t,stores:U.getStoresHandling(t).stores.map(function(t){return t.namespace}).join(","),groups:j(t).join(",")}});console&&console.table?(console.group("Currently Recognized Actions"),console.table(t),console.groupEnd()):console&&console.log&&console.log(t)},printStoreDepTree:function(t){var e=[];t="string"==typeof t?[t]:t,t||(t=Object.keys(D)),t.forEach(function(t){U.getStoresHandling(t).generations.forEach(function(n){for(;n.length;){var o=n.pop();e.push({"action type":t,"store namespace":o.namespace,"waits for":o.waitFor.join(","),generation:o.gen})}}),console&&console.table?(console.group("Store Dependency List for "+t),console.table(e),console.groupEnd()):console&&console.log&&(console.log("Store Dependency List for "+t+":"),console.log(e)),e=[]})}};return{actions:D,addToActionGroup:l,component:d,controllerView:f,customActionCreator:u,dispatcher:U,getActionGroup:c,actionCreatorListener:y,actionCreator:m,actionListener:b,mixin:g,removeStore:E,Store:z,stores:P,utils:V}});