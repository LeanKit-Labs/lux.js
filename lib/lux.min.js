/**
 * lux.js - Flux-based architecture for using ReactJS at LeanKit
 * Author: Jim Cowart
 * Version: v0.2.0
 * Url: https://github.com/LeanKit-Labs/lux.js
 * License(s): MIT Copyright (c) 2014 LeanKit
 */
(function(t,n){if("function"==typeof define&&define.amd)define(["traceur","react","postal.request-response","machina","when","when.pipeline","when.parallel"],n);else{if("object"!=typeof module||!module.exports)throw new Error("Sorry - luxJS only support AMD or CommonJS module environments.");module.exports=function(t,e){return n(require("traceur"),require("react"),t,e,require("when"),require("when/pipeline"),require("when/parallel"))}}})(this,function(t,n,e,i,s,r,a){function o(t){var n,e,i;return $traceurRuntime.createGeneratorInstance(function(s){for(;;)switch(s.state){case 0:n=Object.keys(t)[Symbol.iterator](),s.state=4;break;case 4:s.state=(e=n.next()).done?-2:5;break;case 5:i=e.value,s.state=6;break;case 6:return s.state=2,[i,t[i]];case 2:s.maybeThrow(),s.state=4;break;default:return s.end()}},A,this)}function c(t,n){return n.withContext(t).withConstraint(function(t,n){return!n.hasOwnProperty("originId")||n.originId===e.instanceId()})}function u(t){for(var n,e=[],i=o(t)[Symbol.iterator]();!(n=i.next()).done;){var s=n.value,r=s[0],a=s[1];e.push({actionType:r,waitFor:a.waitFor||[]})}return e}function h(t){return j[t]}function l(t){var n={};return t.forEach(function(t){n[t]=function(){var n=Array.from(arguments);E.publish({topic:"action",data:{actionType:t,actionArgs:n}})}}),n}function f(t,n,e,i){n[e]=function(n){return s(i.apply(t,n.actionArgs.concat([n.deps]))).then(function(t){return[null,t]},function(t){return[t]}).then(function(n){var i=n[1],r=n[0];return r&&"function"==typeof t.handleActionError?s.join(r,i,t.handleActionError(e,r)):s.join(r,i)}).then(function(n){var e=n[1],i=n[0];return s({hasChanged:t.hasChanged,result:e,error:i,state:t.getState()})})}}function p(t,n){for(var e,i={},s=o(n)[Symbol.iterator]();!(e=s.next()).done;){var r=e.value,a=r[0],c=r[1];f(t,i,a,"object"==typeof c?c.handler:c)}return i}function d(t){if(!t.namespace)throw new Error("A lux store must have a namespace value provided");if(!t.handlers)throw new Error("A lux store must have action handler methods provided")}function m(t){F[t].dispose()}function g(t,n){var e=n.reduce(function(n,e){return n[e]=t[e]&&t[e].result,n},{});return e}function b(t,n){var e=this;return function(){return a(t.map(function(t){return function(){var i=Object.assign({deps:g(e.stores,t.waitFor)},n);return E.request({topic:"dispatch."+t.namespace,data:i}).then(function(n){e.stores[t.namespace]=n,n.hasChanged&&e.updated.push(t.namespace)})}})).then(function(){return e.stores})}}function v(t,n,e){e=e||0;var i=e;return t.waitFor&&t.waitFor.length&&t.waitFor.forEach(function(t){var s=n[t],r=v(s,n,e+1);r>i&&(i=r)}),i}function y(t){var n=[],e={};t.forEach(function(t){return e[t.namespace]=t}),t.forEach(function(t){return t.gen=v(t,e)});for(var i,s=o(e)[Symbol.iterator]();!(i=s.next()).done;){var r=i.value,a=(r[0],r[1]);n[a.gen]=n[a.gen]||[],n[a.gen].push(a)}return n}function _(t,n){var e,i={};i[t]=n;var s=this.__luxWaitFor.indexOf(t);s>-1?(this.__luxWaitFor.splice(s,1),this.__luxHeardFrom.push(i),0===this.__luxWaitFor.length&&(i=(e=Object).assign.apply(e,$traceurRuntime.spread([{}],this.__luxHeardFrom)),this.__luxHeardFrom=[],this.stores.onChange.call(this,i))):this.stores.onChange.call(this,i)}function x(t){var n=this;this.__luxWaitFor=t.stores.filter(function(t){return n.stores.listenTo.indexOf(t)>-1})}function w(t){var e={mixins:[H,K].concat(t.mixins||[])};return delete t.mixins,n.createClass(Object.assign(e,t))}function C(t){var e={mixins:[K].concat(t.mixins||[])};return delete t.mixins,n.createClass(Object.assign(e,t))}function S(t){t.__luxCleanup=[],t.stores&&(D.setup.call(t),Object.assign(t,D.mixin),t.__luxCleanup.push(D.teardown)),t.getActionsFor&&M.setup.call(t),t.luxCleanup=q}var A=$traceurRuntime.initGeneratorFunction(o),E=e.channel("lux"),F={},j={},F={},O=function(t){"use strict";var n=this;d(t);var e=t.namespace;if(e in F)throw new Error(' The store namespace "'+e+'" already exists.');F[e]=this,this.changedKeys=[],this.actionHandlers=p(this,t.handlers),j[e]=l(Object.keys(t.handlers)),Object.assign(this,t),this.inDispatch=!1,this.hasChanged=!1,this.state=t.state||{},this.__subscription={dispatch:c(this,E.subscribe("dispatch."+e,this.handlePayload)),notify:c(this,E.subscribe("notify",this.flush)).withConstraint(function(){return n.inDispatch}),scopedNotify:c(this,E.subscribe("notify."+e,this.flush))},E.publish("register",{namespace:e,actions:u(t.handlers)})};$traceurRuntime.createClass(O,{dispose:function(){"use strict";for(var t,n=o(this.__subscription)[Symbol.iterator]();!(t=n.next()).done;){var e=t.value,i=(e[0],e[1]);i.unsubscribe()}delete F[this.namespace]},getState:function(){"use strict";return this.state},setState:function(t){"use strict";var n=this;return this.hasChanged=!0,Object.keys(t).forEach(function(t){n.changedKeys[t]=!0}),this.state=Object.assign(this.state,t)},replaceState:function(t){"use strict";var n=this;return this.hasChanged=!0,Object.keys(t).forEach(function(t){n.changedKeys[t]=!0}),this.state=t},flush:function(){"use strict";if(this.inDispatch=!1,this.hasChanged){var t=Object.keys(this.changedKeys);this.changedKeys={},this.hasChanged=!1,E.publish("notification."+this.namespace,{changedKeys:t,state:this.state})}else E.publish("nochange."+this.namespace)},handlePayload:function(t,n){"use strict";this.namespace;this.actionHandlers.hasOwnProperty(t.actionType)&&(this.inDispatch=!0,this.actionHandlers[t.actionType].call(this,t).then(function(t){return n.reply(null,t)},function(t){return n.reply(t)}))}},{});var T=function(t){"use strict";Object.assign(this,{generationIndex:0,stores:{},updated:[]},t),$traceurRuntime.superCall(this,R.prototype,"constructor",[{initialState:"uninitialized",states:{uninitialized:{start:"dispatching"},dispatching:{_onEnter:function(){var n=this;r(function(){for(var e,i=0,s=[],r=t.generations[Symbol.iterator]();!(e=r.next()).done;){var a=e.value;s[i++]=b.call(n,a,t.action)}return s}()).then(function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];this.transition("success")}.bind(this),function(t){this.err=t,this.transition("failure")}.bind(this))},_onExit:function(){E.publish("prenotify",{stores:this.updated})}},success:{_onEnter:function(){E.publish("notify",{action:this.action}),this.emit("success")}},failure:{_onEnter:function(){E.publish("notify",{action:this.action}),E.publish("failure.action",{action:this.action,err:this.err}),this.emit("failure")}}}}])},R=T;$traceurRuntime.createClass(T,{success:function(t){"use strict";var n=this;return this.on("success",t),this._started||(setTimeout(function(){return n.handle("start")},0),this._started=!0),this},failure:function(t){"use strict";var n=this;return this.on("error",t),this._started||(setTimeout(function(){return n.handle("start")},0),this._started=!0),this}},{},i.Fsm);var k=function(){"use strict";$traceurRuntime.superCall(this,$.prototype,"constructor",[{initialState:"ready",actionMap:{},coordinators:[],states:{ready:{_onEnter:function(){this.luxAction={}},"action.dispatch":function(t){this.luxAction={action:t},this.transition("preparing")},"register.store":function(t){for(var n,e=t.actions[Symbol.iterator]();!(n=e.next()).done;){var i,s=n.value,r=s.actionType,a={namespace:t.namespace,waitFor:s.waitFor};i=this.actionMap[r]=this.actionMap[r]||[],i.push(a)}}},preparing:{_onEnter:function(){var t=this.actionMap[this.luxAction.action.actionType];this.luxAction.stores=t,this.luxAction.generations=y(t),this.transition(this.luxAction.generations.length?"dispatching":"ready")},"*":function(){this.deferUntilTransition("ready")}},dispatching:{_onEnter:function(){var t=this,n=this.luxAction.coordinator=new T({generations:this.luxAction.generations,action:this.luxAction.action});n.success(function(){return t.transition("ready")}).failure(function(){return t.transition("ready")})},"*":function(){this.deferUntilTransition("ready")}},stopped:{}}}]),this.__subscriptions=[c(this,E.subscribe("action",function(t){this.handleActionDispatch(t)})),c(this,E.subscribe("register",function(t){this.handleStoreRegistration(t)}))]},$=k;$traceurRuntime.createClass(k,{handleActionDispatch:function(t){"use strict";this.handle("action.dispatch",t)},handleStoreRegistration:function(t){"use strict";this.handle("register.store",t)},dispose:function(){"use strict";this.transition("stopped"),this.__subscriptions.forEach(function(t){return t.unsubscribe()})}},{},i.Fsm);var W=new k,q=function(){var t=this;this.__luxCleanup.forEach(function(n){return n.call(t)}),this.__luxCleanup=void 0,delete this.__luxCleanup},D={setup:function(){var t,n=this,e=this.stores=this.stores||{},i=e.immediate,s="string"==typeof e.listenTo?[e.listenTo]:e.listenTo,r=function(t){if("function"==typeof this.setState){for(var n,e={},i=o(t)[Symbol.iterator]();!(n=i.next()).done;){var s=n.value,r=s[0],a=s[1];e[r]=a.state}this.setState(e)}};this.__luxWaitFor=[],this.__luxHeardFrom=[],this.__subscriptions=this.__subscriptions||[],e.onChange=e.onChange||r,s.forEach(function(t){return n.__subscriptions.push(E.subscribe("notification."+t,function(e){return _.call(n,t,e)}))}),this.__subscriptions.push(E.subscribe("prenotify",function(t){return x.call(n,t)})),i&&(i===!0?this.loadState():(t=this).loadState.apply(t,$traceurRuntime.spread(i)))},teardown:function(){this.__subscriptions.forEach(function(t){return t.unsubscribe()})},mixin:{loadState:function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];t.length||(t=this.stores.listenTo),t.forEach(function(t){return E.publish("notify."+t)})}}},H={componentWillMount:D.setup,loadState:D.mixin.loadState,componentWillUnmount:D.teardown},M={setup:function(){this.actions=this.actions||{},this.getActionsFor=this.getActionsFor||[],this.getActionsFor.forEach(function(t){for(var n,e=o(h(t))[Symbol.iterator]();!(n=e.next()).done;){var i=n.value,s=i[0],r=i[1];this[s]=r}}.bind(this))}},K={componentWillMount:M.setup};return{channel:E,Store:O,createControllerView:w,createComponent:C,removeStore:m,dispatcher:W,mixin:S,ActionCoordinator:T,getActionCreatorFor:h}});