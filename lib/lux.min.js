/**
 * lux.js - Flux-based architecture for using ReactJS at LeanKit
 * Author: Jim Cowart
 * Version: v0.3.3
 * Url: https://github.com/LeanKit-Labs/lux.js
 * License(s): MIT Copyright (c) 2014 LeanKit
 */
(function(t,n){if("function"==typeof define&&define.amd)define(["traceur","react","postal","machina","lodash"],n);else{if("object"!=typeof module||!module.exports)throw new Error("Sorry - luxJS only support AMD or CommonJS module environments.");module.exports=function(t,e,r,i){return n(require("traceur"),t||require("react"),e||require("postal"),r||require("machina"),i||require("lodash"))}}})(this,function(t,n,e,r,i){function o(t){var n,e,r;return $traceurRuntime.createGeneratorInstance(function(i){for(;;)switch(i.state){case 0:-1===["object","function"].indexOf(typeof t)&&(t={}),i.state=10;break;case 10:n=Object.keys(t)[$traceurRuntime.toProperty(Symbol.iterator)](),i.state=4;break;case 4:i.state=(e=n.next()).done?-2:5;break;case 5:r=e.value,i.state=6;break;case 6:return i.state=2,[r,t[r]];case 2:i.maybeThrow(),i.state=4;break;default:return i.end()}},$,this)}function a(t,n){var e=n.reduce(function(n,e){return n[e]=t[e],n},{});return e}function s(t,n){return n.context(t).constraint(function(t,n){return!n.hasOwnProperty("originId")||n.originId===e.instanceId()})}function c(t){{var n=t.__lux=t.__lux||{};n.cleanup=n.cleanup||[],n.subscriptions=n.subscriptions||{}}return n}function u(t){for(var n,e=[],r=o(t)[$traceurRuntime.toProperty(Symbol.iterator)]();!(n=r.next()).done;){var i=n.value,a=i[0],s=i[1];e.push({actionType:a,waitFor:s.waitFor||[]})}return e}function h(t){t="string"==typeof t?[t]:t,t.forEach(function(t){D[t]||(D[t]=function(){var n=Array.from(arguments);P.publish({topic:"execute."+t,data:{actionType:t,actionArgs:n}})})})}function l(t){if(I[t])return a(D,I[t]);throw new Error("There is no action group named '"+t+"'")}function p(t){D=Object.assign(D,t)}function f(t,n){var e=I[t];e||(e=I[t]=[]),n="string"==typeof n?[n]:n,n.forEach(function(t){-1===e.indexOf(t)&&e.push(t)})}function d(t){var n={};n[t]=!0;var e=this.__lux,r=e.waitFor.indexOf(t);r>-1?(e.waitFor.splice(r,1),e.heardFrom.push(n),0===e.waitFor.length&&(e.heardFrom=[],this.stores.onChange.call(this,n))):this.stores.onChange.call(this,n)}function m(t){var n=this;this.__lux.waitFor=t.stores.filter(function(t){return n.stores.listenTo.indexOf(t)>-1})}function g(t){var e={mixins:[H,U].concat(t.mixins||[])};return delete t.mixins,n.createClass(Object.assign(e,t))}function v(t){var e={mixins:[U].concat(t.mixins||[])};return delete t.mixins,n.createClass(Object.assign(e,t))}function y(t){for(var n=[],e=1;e<arguments.length;e++)n[e-1]=arguments[e];return 0===n.length&&(n=[q,z]),n.forEach(function(n){"function"==typeof n&&(n=n()),n.mixin&&Object.assign(t,n.mixin),n.setup.call(t),n.teardown&&t.__lux.cleanup.push(n.teardown)}),t.luxCleanup=J,t}function b(t){return y(t,W)}function x(t){return y(t,z)}function w(t){return x(b(t))}function A(t,n,e){var r=t&&t.namespace||e.namespace;if(r in L)throw new Error(' The store namespace "'+r+'" already exists.');if(!r)throw new Error("A lux store must have a namespace value provided");if(!n||!Object.keys(n).length)throw new Error("A lux store must have action handler methods provided")}function _(t,n,e){return{waitFor:[],handler:function(){var t=0,r=Array.from(arguments);return e[n].forEach(function(n){t+=n.apply(this,r)===!1?0:1}.bind(this)),t>0}}}function E(t,n){t.waitFor&&t.waitFor.forEach(function(t){-1===n.waitFor.indexOf(t)&&n.waitFor.push(t)})}function S(t,n,e){t[n]=t[n]||[],t[n].push(e.handler||e)}function F(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];var e={},r={},o={},a={};return t.forEach(function(t){var n;t&&(n=i.clone(t),i.merge(o,n.state),n.handlers&&Object.keys(n.handlers).forEach(function(t){var i=n.handlers[t];r[t]=r[t]||_(r,t,e),E(i,r[t]),S(e,t,i)}),delete n.handlers,delete n.state,i.merge(a,n))}),[o,r,a]}function C(t){L[t].dispose()}function O(t,n){var e=this;t.map(function(t){var r=Object.assign({deps:a(e.stores,t.waitFor)},n);G.publish(t.namespace+".handle."+n.actionType,r)})}function T(t,n,e){var r=e;return t.waitFor&&t.waitFor.length&&t.waitFor.forEach(function(t){var i=n[t];if(i){var o=T(i,n,e+1);o>r&&(r=o)}}),r}function j(t,n){var e=[],r={};t.forEach(function(t){return r[t.namespace]=t}),t.forEach(function(t){return t.gen=T(t,r,0,n)});for(var i,a=o(r)[$traceurRuntime.toProperty(Symbol.iterator)]();!(i=a.next()).done;){var s=i.value,c=(s[0],s[1]);e[c.gen]=e[c.gen]||[],e[c.gen].push(c)}return e}function R(t){for(var n,e=[],r=o(I)[$traceurRuntime.toProperty(Symbol.iterator)]();!(n=r.next()).done;){var i=n.value,a=i[0],s=i[1];s.indexOf(t)>=0&&e.push(a)}return e}var $=$traceurRuntime.initGeneratorFunction(o),P=e.channel("lux.action"),k=e.channel("lux.store"),G=e.channel("lux.dispatcher"),L={},M=function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];for(var e,r,o=this,a=function(){},s=[],c=t[$traceurRuntime.toProperty(Symbol.iterator)]();!(r=c.next()).done;){var u=r.value;s.push(i.pick(u,["handlers","state"])),delete u.handlers,delete u.state}var h=i.merge.apply(this,[{}].concat(t));return e=h&&h.hasOwnProperty("constructor")?h.constructor:function(){var t=Array.from(arguments);t[0]=t[0]||{},o.apply(this,e.mixins.concat(t))},e.mixins=s,i.merge(e,o),a.prototype=o.prototype,e.prototype=new a,h&&i.extend(e.prototype,h),e.prototype.constructor=e,e.__super__=o.prototype,e},D=Object.create(null),I={},q={setup:function(){var t=this,n=c(this),e=this.stores=this.stores||{};if(!e.listenTo)throw new Error("listenTo must contain at least one store namespace");var r="string"==typeof e.listenTo?[e.listenTo]:e.listenTo;if(!e.onChange)throw new Error("A component was told to listen to the following store(s): "+r+" but no onChange handler was implemented");n.waitFor=[],n.heardFrom=[],r.forEach(function(e){n.subscriptions[e+".changed"]=k.subscribe(e+".changed",function(){return d.call(t,e)})}),n.subscriptions.prenotify=G.subscribe("prenotify",function(n){return m.call(t,n)})},teardown:function(){for(var t,n=o(this.__lux.subscriptions)[$traceurRuntime.toProperty(Symbol.iterator)]();!(t=n.next()).done;){var e,r=t.value,i=r[0],a=r[1];("prenotify"===i||(e=i.split("."))&&"changed"===e[1])&&a.unsubscribe()}},mixin:{}},H={componentWillMount:q.setup,loadState:q.mixin.loadState,componentWillUnmount:q.teardown},z={setup:function(){var t=this;this.getActionGroup=this.getActionGroup||[],this.getActions=this.getActions||[],"string"==typeof this.getActionGroup&&(this.getActionGroup=[this.getActionGroup]),"string"==typeof this.getActions&&(this.getActions=[this.getActions]);var n=function(n,e){t[n]||(t[n]=e)};this.getActionGroup.forEach(function(t){for(var e,r=o(l(t))[$traceurRuntime.toProperty(Symbol.iterator)]();!(e=r.next()).done;){var i=e.value,a=i[0],s=i[1];n(a,s)}}),this.getActions.length&&this.getActions.forEach(function(t){var e=D[t];if(!e)throw new Error("There is no action named '"+t+"'");n(t,e)})},mixin:{publishAction:function(t){for(var n=[],e=1;e<arguments.length;e++)n[e-1]=arguments[e];P.publish({topic:"execute."+t,data:{actionType:t,actionArgs:n}})}}},U={componentWillMount:z.setup,publishAction:z.mixin.publishAction},W=function(){var t=void 0!==arguments[0]?arguments[0]:{},n=t.handlers,e=t.handlerFn,r=t.context,i=t.channel,o=t.topic;return{setup:function(){r=r||this;var t=c(r),a=t.subscriptions;if(n=n||r.handlers,i=i||P,o=o||"execute.*",e=e||function(t){var e;(e=n[t.actionType])&&e.apply(r,t.actionArgs)},!n||!Object.keys(n).length)throw new Error("You must have at least one action handler in the handlers property");if(!a||!a.actionListener){a.actionListener=s(r,i.subscribe(o,e));var u=Object.keys(n);h(u),r.namespace&&f(r.namespace,u)}},teardown:function(){this.__lux.subscriptions.actionListener.unsubscribe()}}},J=function(){var t=this;this.__lux.cleanup.forEach(function(n){return n.call(t)}),this.__lux.cleanup=void 0,delete this.__lux.cleanup};y.store=q,y.actionCreator=z,y.actionListener=W;var V=function(){"use strict";for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];var e=F.apply(null,$traceurRuntime.spread(t)),r=e[0],i=e[1],o=e[2];A(o,i,this);var a=o.namespace||this.namespace;Object.assign(this,o),L[a]=this;var c=!1;this.hasChanged=!1,this.getState=function(){return r},this.setState=function(t){if(!c)throw new Error("setState can only be called during a dispatch cycle from a store action handler.");r=Object.assign(r,t)},this.flush=function(){c=!1,this.hasChanged&&(this.hasChanged=!1,k.publish(this.namespace+".changed"))},y(this,W({context:this,channel:G,topic:a+".handle.*",handlers:i,handlerFn:function(t){if(i.hasOwnProperty(t.actionType)){c=!0;var n=i[t.actionType].handler.apply(this,t.actionArgs.concat(t.deps));this.hasChanged=n===!1?!1:!0,G.publish(this.namespace+".handled."+t.actionType,{hasChanged:this.hasChanged,namespace:this.namespace})}}.bind(this)})),this.__subscription={notify:s(this,G.subscribe("notify",this.flush)).constraint(function(){return c})},Q.registerStore({namespace:a,actions:u(i)})};$traceurRuntime.createClass(V,{dispose:function(){"use strict";for(var t,n=o(this.__subscription)[$traceurRuntime.toProperty(Symbol.iterator)]();!(t=n.next()).done;){var e=t.value,r=(e[0],e[1]);r.unsubscribe()}delete L[this.namespace],Q.removeStore(this.namespace)}},{}),V.extend=M;var Y=function(t){"use strict";var n=this;Object.assign(this,{generationIndex:0,stores:{},updated:[]},t),this.__subscriptions={handled:G.subscribe("*.handled.*",function(t){return n.handle("action.handled",t)})},$traceurRuntime.superConstructor(B).call(this,{initialState:"uninitialized",states:{uninitialized:{start:"dispatching"},dispatching:{_onEnter:function(){var n=this;try{(function(){for(var e,r=0,i=[],o=t.generations[$traceurRuntime.toProperty(Symbol.iterator)]();!(e=o.next()).done;){var a=e.value;i[r++]=O.call(n,a,t.action)}return i})(),this.transition("success")}catch(e){this.err=e,this.transition("failure")}},"action.handled":function(t){t.hasChanged&&this.updated.push(t.namespace)},_onExit:function(){G.publish("prenotify",{stores:this.updated})}},success:{_onEnter:function(){G.publish("notify",{action:this.action}),this.emit("success")}},failure:{_onEnter:function(){G.publish("notify",{action:this.action}),G.publish("action.failure",{action:this.action,err:this.err}),this.emit("failure")}}}})},B=Y;$traceurRuntime.createClass(Y,{start:function(){"use strict";this.handle("start")}},{},r.Fsm);var K=function(){"use strict";var t=this;$traceurRuntime.superConstructor(N).call(this,{initialState:"ready",actionMap:{},coordinators:[],states:{ready:{_onEnter:function(){this.luxAction={}},"action.dispatch":function(t){this.luxAction={action:t},this.transition("preparing")},"register.store":function(t){for(var n,e=t.actions[$traceurRuntime.toProperty(Symbol.iterator)]();!(n=e.next()).done;){var r,i=n.value,o=i.actionType,a={namespace:t.namespace,waitFor:i.waitFor};r=this.actionMap[o]=this.actionMap[o]||[],r.push(a)}},"remove.store":function(t){for(var n,e=function(n){return n.namespace===t},r=o(this.actionMap)[$traceurRuntime.toProperty(Symbol.iterator)]();!(n=r.next()).done;){var i=n.value,a=(i[0],i[1]),s=a.findIndex(e);-1!==s&&a.splice(s,1)}}},preparing:{_onEnter:function(){var t=this.getStoresHandling(this.luxAction.action.actionType);this.luxAction.stores=t.stores,this.luxAction.generations=t.tree,this.transition(this.luxAction.generations.length?"dispatching":"ready")},"*":function(){this.deferUntilTransition("ready")}},dispatching:{_onEnter:function(){var t=new Y({generations:this.luxAction.generations,action:this.luxAction.action});t.start(),this.transition("ready")},"*":function(){this.deferUntilTransition("ready")}},stopped:{}},getStoresHandling:function(t){var n=this.actionMap[t]||[];return{stores:n,tree:j(n,t)}}}),this.__subscriptions=[s(this,P.subscribe("execute.*",function(n){return t.handleActionDispatch(n)}))]},N=K;$traceurRuntime.createClass(K,{handleActionDispatch:function(t){"use strict";this.handle("action.dispatch",t)},registerStore:function(t){"use strict";this.handle("register.store",t)},removeStore:function(t){"use strict";this.handle("remove.store",t)},dispose:function(){"use strict";this.transition("stopped"),this.__subscriptions.forEach(function(t){return t.unsubscribe()})}},{},r.Fsm);var Q=new K,X={printActions:function(){var t=Object.keys(D).map(function(t){return{"action name":t,stores:Q.getStoresHandling(t).stores.map(function(t){return t.namespace}).join(","),groups:R(t).join(",")}});console&&console.table?(console.group("Currently Recognized Actions"),console.table(t),console.groupEnd()):console&&console.log&&console.log(t)},printStoreDepTree:function(t){var n=[];t="string"==typeof t?[t]:t,t||(t=Object.keys(D)),t.forEach(function(t){Q.getStoresHandling(t).tree.forEach(function(e){for(;e.length;){var r=e.pop();n.push({"action type":t,"store namespace":r.namespace,"waits for":r.waitFor.join(","),generation:r.gen})}}),console&&console.table?(console.group("Store Dependency List for "+t),console.table(n),console.groupEnd()):console&&console.log&&(console.log("Store Dependency List for "+t+":"),console.log(n)),n=[]})}};return{actions:D,addToActionGroup:f,component:v,controllerView:g,customActionCreator:p,dispatcher:Q,getActionGroup:l,actionCreatorListener:w,actionCreator:x,actionListener:b,mixin:y,removeStore:C,Store:V,stores:L,utils:X}});