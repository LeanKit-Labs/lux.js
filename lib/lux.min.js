/**
 * lux.js - Flux-based architecture for using ReactJS at LeanKit
 * Author: Jim Cowart
 * Version: v0.1.0
 * Url: https://github.com/LeanKit-Labs/lux.js
 * License(s): MIT Copyright (c) 2014 LeanKit
 */
(function(t,n){if("function"==typeof define&&define.amd)define(["traceur","react","postal.request-response","machina","when","when.pipeline","when.parallel"],n);else{if("object"!=typeof module||!module.exports)throw new Error("Sorry - luxJS only support AMD or CommonJS module environments.");module.exports=function(t,e){return n(require("traceur"),require("react"),t,e,require("when"),require("when/pipeline"),require("when/parallel"))}}})(this,function(t,n,e,i,r,s,a){function o(t){var n,e,i;return $traceurRuntime.createGeneratorInstance(function(r){for(;;)switch(r.state){case 0:n=Object.keys(t)[Symbol.iterator](),r.state=4;break;case 4:r.state=(e=n.next()).done?-2:5;break;case 5:i=e.value,r.state=6;break;case 6:return r.state=2,[i,t[i]];case 2:r.maybeThrow(),r.state=4;break;default:return r.end()}},S,this)}function c(t,n){return n.withContext(t).withConstraint(function(t,n){return!n.hasOwnProperty("originId")||n.originId===e.instanceId()})}function u(t){for(var n,e=[],i=o(t)[Symbol.iterator]();!(n=i.next()).done;){var r=n.value,s=r[0],a=r[1];e.push({actionType:s,waitFor:a.waitFor||[]})}return e}function h(t){return A[t]}function l(t){var n={};return t.forEach(function(t){n[t]=function(){var n=Array.from(arguments);C.publish({topic:"action",data:{actionType:t,actionArgs:n}})}}),n}function f(t,n,e,i){n[e]=function(n){var e=i.apply(t,n.actionArgs.concat([n.deps]));return r.join(r(e).then(function(t){return[null,t]},function(t){return[t]}),t.getState()).then(function(t){var n=t[0][1],e=t[0][0];return r({result:n,error:e,state:t[1]})})}}function p(t,n){for(var e,i={},r=o(n)[Symbol.iterator]();!(e=r.next()).done;){var s=e.value,a=s[0],c=s[1];f(t,i,a,"object"==typeof c?c.handler:c)}return i}function d(t){var n,e,i=t,r=i.namespace,s=void 0===(n=i.handlers)?{}:n,a=void 0===(e=i.transportStrategy)?new F:e;if(r in E)throw new Error(' The store namespace "'+r+'" already exists.');var o=new O(r,s,a);return A[r]=l(Object.keys(s)),o}function m(t){E[t].dispose(),delete E[t]}function g(t,n){var e=n.reduce(function(n,e){return n[e]=t[e]&&t[e].result,n},{});return e}function v(t,n){var e=this;return function(){return a(t.map(function(t){return function(){var i=Object.assign({deps:g(e.stores,t.waitFor)},n);return C.request({topic:"dispatch."+t.namespace,data:i}).then(function(n){e.stores[t.namespace]=e.stores[t.namespace]||{},e.stores[t.namespace].result=n.result})}})).then(function(){return e.stores})}}function b(t,n,e){e=e||0;var i=e;return t.waitFor&&t.waitFor.length&&t.waitFor.forEach(function(t){var r=n[t],s=b(r,n,e+1);s>i&&(i=s)}),i}function y(t){var n=[],e={};t.forEach(function(t){return e[t.namespace]=t}),t.forEach(function(t){return t.gen=b(t,e)});for(var i,r=o(e)[Symbol.iterator]();!(i=r.next()).done;){var s=i.value,a=(s[0],s[1]);n[a.gen]=n[a.gen]||[],n[a.gen].push(a)}return n}function x(t){var e={mixins:[P,K].concat(t.mixins||[])};return delete t.mixins,n.createClass(Object.assign(e,t))}function _(t){var e={mixins:[K].concat(t.mixins||[])};return delete t.mixins,n.createClass(Object.assign(e,t))}function w(t){if(t.__luxCleanup=[],t.stores){M.setup.call(t);for(var n in M.mixin)M.mixin.hasOwnProperty(n)||(t[n]=M.mixin[n]);t.__luxCleanup.push(M.teardown)}t.getActionsFor&&D.setup.call(t),t.luxCleanup=q}var S=$traceurRuntime.initGeneratorFunction(o),C=e.channel("lux"),E={},A={},F=function(t){"use strict";this.state=t||{},this.changedKeys=[]};$traceurRuntime.createClass(F,{getState:function(){"use strict";return new Promise(function(t){t(this.state)}.bind(this))},setState:function(t){"use strict";var n=this;Object.keys(t).forEach(function(t){n.changedKeys[t]=!0}),this.state=Object.assign(this.state,t)},replaceState:function(t){"use strict";var n=this;Object.keys(t).forEach(function(t){n.changedKeys[t]=!0}),this.state=t},flush:function(){"use strict";var t=Object.keys(this.changedKeys);return this.changedKeys={},{changedKeys:t,state:this.state}}},{});var O=function(t,n,e){"use strict";var i=this;this.namespace=t,this.transport=e,this.actionHandlers=p(this,n),this.__subscription={dispatch:c(this,C.subscribe("dispatch."+t,this.handlePayload)),notify:c(this,C.subscribe("notify",this.flush)).withConstraint(function(){return i.inDispatch}),scopedNotify:c(this,C.subscribe("notify."+t,this.flush))},C.publish("register",{namespace:t,actions:u(n)})};$traceurRuntime.createClass(O,{dispose:function(){"use strict";for(var t,n=o(this.__subscription)[Symbol.iterator]();!(t=n.next()).done;){var e=t.value,i=(e[0],e[1]);i.unsubscribe()}},getState:function(){"use strict";for(var t,n=[],e=0;e<arguments.length;e++)n[e]=arguments[e];return(t=this.transport).getState.apply(t,$traceurRuntime.spread(n))},setState:function(){"use strict";for(var t,n=[],e=0;e<arguments.length;e++)n[e]=arguments[e];return(t=this.transport).setState.apply(t,$traceurRuntime.spread(n))},replaceState:function(){"use strict";for(var t,n=[],e=0;e<arguments.length;e++)n[e]=arguments[e];return(t=this.transport).replaceState.apply(t,$traceurRuntime.spread(n))},flush:function(){"use strict";this.inDispatch=!1,C.publish("notification."+this.namespace,this.transport.flush())},handlePayload:function(t,n){"use strict";var e=this.namespace;this.actionHandlers.hasOwnProperty(t.actionType)&&(this.inDispatch=!0,this.actionHandlers[t.actionType].call(this,t).then(function(t){return n.reply(null,{result:t,namespace:e})},function(t){return n.reply(t)}))}},{});var R=function(t){"use strict";Object.assign(this,{generationIndex:0,stores:{}},t),$traceurRuntime.superCall(this,j.prototype,"constructor",[{initialState:"uninitialized",states:{uninitialized:{start:"dispatching"},dispatching:{_onEnter:function(){var n=this;s(function(){for(var e,i=0,r=[],s=t.generations[Symbol.iterator]();!(e=s.next()).done;){var a=e.value;r[i++]=v.call(n,a,t.action)}return r}()).then(function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];this.results=t,this.transition("success")}.bind(this),function(t){this.err=t,this.transition("failure")}.bind(this))},_onExit:function(){C.publish("dispatchCycle")}},success:{_onEnter:function(){C.publish("notify",{action:this.action}),this.emit("success")}},failure:{_onEnter:function(){C.publish("notify",{action:this.action}),C.publish("failure.action",{action:this.action,err:this.err}),this.emit("failure")}}}}])},j=R;$traceurRuntime.createClass(R,{success:function(t){"use strict";var n=this;return this.on("success",t),this._started||(setTimeout(function(){return n.handle("start")},0),this._started=!0),this},failure:function(t){"use strict";var n=this;return this.on("error",t),this._started||(setTimeout(function(){return n.handle("start")},0),this._started=!0),this}},{},i.Fsm);var T=function(){"use strict";$traceurRuntime.superCall(this,$.prototype,"constructor",[{initialState:"ready",actionMap:{},coordinators:[],states:{ready:{_onEnter:function(){this.luxAction={}},"action.dispatch":function(t){this.luxAction={action:t},this.transition("preparing")},"register.store":function(t){for(var n,e=t.actions[Symbol.iterator]();!(n=e.next()).done;){var i,r=n.value,s=r.actionType,a={namespace:t.namespace,waitFor:r.waitFor};i=this.actionMap[s]=this.actionMap[s]||[],i.push(a)}}},preparing:{_onEnter:function(){var t=this.actionMap[this.luxAction.action.actionType];this.luxAction.generations=y(t),this.transition(this.luxAction.generations.length?"dispatching":"ready")},"*":function(){this.deferUntilTransition("ready")}},dispatching:{_onEnter:function(){var t=this,n=this.luxAction.coordinator=new R({generations:this.luxAction.generations,action:this.luxAction.action});n.success(function(){return t.transition("ready")}).failure(function(){return t.transition("ready")})},"*":function(){this.deferUntilTransition("ready")}},stopped:{}}}]),this.__subscriptions=[c(this,C.subscribe("action",function(t){this.handleActionDispatch(t)})),c(this,C.subscribe("register",function(t){this.handleStoreRegistration(t)}))]},$=T;$traceurRuntime.createClass(T,{handleActionDispatch:function(t){"use strict";this.handle("action.dispatch",t)},handleStoreRegistration:function(t){"use strict";this.handle("register.store",t)},dispose:function(){"use strict";this.transition("stopped"),this.__subscriptions.forEach(function(t){return t.unsubscribe()})}},{},i.Fsm);var k=new T,q=function(){var t=this;this.__luxCleanup.forEach(function(n){return n.call(t)}),this.__luxCleanup=void 0,delete this.__luxCleanup},M={setup:function(){var t;this.stores=this.stores||[],this.stateChangeHandlers=this.stateChangeHandlers||{};var n=function(t){this.setState(t.state||t)};this.__subscriptions=this.__subscriptions||[];var e=[];this.stores.forEach(function(t){var i=this,r=t.store||t,s=t.handler||n;this.__subscriptions.push(C.subscribe("notification."+r,function(t){return s.call(i,t)})),t.immediate&&e.push(r)}.bind(this)),e.length&&(t=this).loadState.apply(t,$traceurRuntime.spread(e))},teardown:function(){this.__subscriptions.forEach(function(t){return t.unsubscribe()})},mixin:{loadState:function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];t.length||(t=this.stores.map(function(t){return t.store})),t.forEach(function(t){return C.publish("notify."+t)})}}},P={componentWillMount:M.setup,loadState:M.mixin.loadState,componentWillUnmount:M.teardown},D={setup:function(){this.actions=this.actions||{},this.getActionsFor=this.getActionsFor||[],this.getActionsFor.forEach(function(t){for(var n,e=o(h(t))[Symbol.iterator]();!(n=e.next()).done;){var i=n.value,r=i[0],s=i[1];this.hasOwnProperty(r)||(this[r]=s)}}.bind(this))}},K={componentWillMount:D.setup};return{channel:C,stores:E,createStore:d,createControllerView:x,createComponent:_,removeStore:m,dispatcher:k,mixin:w,ActionCoordinator:R,getActionCreatorFor:h}});